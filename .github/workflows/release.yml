name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: repub
          POSTGRES_PASSWORD: repub
          POSTGRES_DB: repub
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U repub"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4

      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Install Melos
        run: dart pub global activate melos

      - name: Bootstrap workspace
        run: melos bootstrap

      - name: Analyze
        run: melos run analyze

      - name: Start MinIO
        run: |
          docker run -d --name minio \
            -p 9000:9000 \
            -e MINIO_ROOT_USER=minioadmin \
            -e MINIO_ROOT_PASSWORD=minioadmin \
            minio/minio:latest server /data

          sleep 5

          docker run --rm --network host \
            --entrypoint /bin/sh minio/mc:latest -c "
              mc alias set local http://localhost:9000 minioadmin minioadmin &&
              mc mb local/repub
            "

      - name: Run unit tests
        run: melos run test

      - name: Run integration tests
        env:
          REPUB_DATABASE_URL: postgres://repub:repub@localhost:5432/repub
          REPUB_S3_ENDPOINT: http://localhost:9000
          REPUB_S3_ACCESS_KEY: minioadmin
          REPUB_S3_SECRET_KEY: minioadmin
          REPUB_S3_BUCKET: repub
          REPUB_S3_REGION: us-east-1
        run: |
          cd packages/repub_cli
          dart run repub_cli migrate
          cd ../repub_server
          if [ -d "integration_test" ]; then
            dart test integration_test/
          else
            echo "No integration tests found, skipping"
          fi

  build:
    name: Build Release Binaries
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Install Melos
        run: dart pub global activate melos

      - name: Bootstrap workspace
        run: melos bootstrap

      - name: Compile server binary
        run: |
          dart compile exe packages/repub_server/bin/repub_server.dart \
            -o repub_server-linux-x64

      - name: Compile CLI binary
        run: |
          dart compile exe packages/repub_cli/bin/repub_cli.dart \
            -o repub_cli-linux-x64

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-linux-x64
          path: |
            repub_server-linux-x64
            repub_cli-linux-x64

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -type f -exec mv {} release/ \;
          cd release
          for file in *; do
            sha256sum "$file" >> checksums.txt
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ inputs.version }}
          name: v${{ inputs.version }}
          files: release/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ inputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker:
    name: Trigger Docker Build
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Docker workflow
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'docker.yml',
              ref: 'main',
              inputs: {
                tag: 'v${{ inputs.version }}',
                'git-ref': 'v${{ inputs.version }}',
                test: 'false'
              }
            });
            // Docker workflow auto-tags latest when tag is not 'latest'
