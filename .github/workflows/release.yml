name: Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.bump_version.outputs.new_tag }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: get_tag
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

          # Remove 'v' prefix for version manipulation
          VERSION=${LATEST_TAG#v}
          echo "current_version=$VERSION" >> $GITHUB_OUTPUT

      - name: Bump version
        id: bump_version
        run: |
          VERSION="${{ steps.get_tag.outputs.current_version }}"
          IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"

          MAJOR="${VERSION_PARTS[0]}"
          MINOR="${VERSION_PARTS[1]}"
          PATCH="${VERSION_PARTS[2]}"

          case "${{ github.event.inputs.version_bump }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          NEW_TAG="v$NEW_VERSION"

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          PREVIOUS_TAG="${{ steps.get_tag.outputs.latest_tag }}"
          NEW_TAG="${{ steps.bump_version.outputs.new_tag }}"

          # Get commits since last tag
          COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)

          # Categorize commits
          FEATURES=$(echo "$COMMITS" | grep -i "^- feat" || true)
          FIXES=$(echo "$COMMITS" | grep -i "^- fix" || true)
          DOCS=$(echo "$COMMITS" | grep -i "^- docs" || true)
          CHORES=$(echo "$COMMITS" | grep -i "^- chore\|^- ci\|^- style" || true)

          # Build release notes
          cat > release_notes.md << 'EOFNOTES'
          ## Changes in $NEW_TAG

          EOFNOTES

          if [ -n "$FEATURES" ]; then
            cat >> release_notes.md << 'EOFNOTES'
          ### Features
          $FEATURES

          EOFNOTES
          fi

          if [ -n "$FIXES" ]; then
            cat >> release_notes.md << 'EOFNOTES'
          ### Bug Fixes
          $FIXES

          EOFNOTES
          fi

          if [ -n "$DOCS" ]; then
            cat >> release_notes.md << 'EOFNOTES'
          ### Documentation
          $DOCS

          EOFNOTES
          fi

          if [ -n "$CHORES" ]; then
            cat >> release_notes.md << 'EOFNOTES'
          ### Maintenance
          $CHORES

          EOFNOTES
          fi

          cat >> release_notes.md << 'EOFNOTES'
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${NEW_TAG}
          EOFNOTES

          # Replace variables in notes
          sed -i "s|\$NEW_TAG|$NEW_TAG|g" release_notes.md
          sed -i "s|\$FEATURES|$FEATURES|g" release_notes.md
          sed -i "s|\$FIXES|$FIXES|g" release_notes.md
          sed -i "s|\$DOCS|$DOCS|g" release_notes.md
          sed -i "s|\$CHORES|$CHORES|g" release_notes.md
          sed -i "s|\${PREVIOUS_TAG}|$PREVIOUS_TAG|g" release_notes.md
          sed -i "s|\${NEW_TAG}|$NEW_TAG|g" release_notes.md

          cat release_notes.md

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a ${{ steps.bump_version.outputs.new_tag }} -m "Release ${{ steps.bump_version.outputs.new_tag }}"
          git push origin ${{ steps.bump_version.outputs.new_tag }}

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create ${{ steps.bump_version.outputs.new_tag }} \
            --title "${{ steps.bump_version.outputs.new_tag }}" \
            --notes-file release_notes.md

  docker:
    name: Build and Push Docker Image
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.new_tag }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Extract version
        id: version
        run: |
          VERSION=${{ needs.release.outputs.new_tag }}
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/gsmlg-dev/repub:${{ needs.release.outputs.new_tag }}
            ghcr.io/gsmlg-dev/repub:${{ steps.version.outputs.version }}
            ghcr.io/gsmlg-dev/repub:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
