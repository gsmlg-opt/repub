name: Test

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Install Melos
        run: dart pub global activate melos

      - name: Bootstrap workspace
        run: melos bootstrap

      - name: Run tests
        run: |
          for pkg in packages/*; do
            if [ -d "$pkg/test" ] && [ "$(ls -A "$pkg/test" 2>/dev/null)" ]; then
              echo "Testing $pkg..."
              (cd "$pkg" && dart test --reporter=expanded)
            else
              echo "Skipping $pkg (no tests)"
            fi
          done

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: repub
          POSTGRES_PASSWORD: repub
          POSTGRES_DB: repub
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      REPUB_URL: http://localhost:8080
      REPUB_LISTEN_ADDR: "0.0.0.0:8080"
      REPUB_BASE_URL: "http://localhost:8080"
      REPUB_DATABASE_URL: postgres://repub:repub@localhost:5432/repub
      REPUB_S3_ENDPOINT: "http://localhost:9000"
      REPUB_S3_REGION: "us-east-1"
      REPUB_S3_ACCESS_KEY: "minioadmin"
      REPUB_S3_SECRET_KEY: "minioadmin"
      REPUB_S3_BUCKET: "repub"

    steps:
      - uses: actions/checkout@v4

      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Install Melos
        run: dart pub global activate melos

      - name: Bootstrap workspace
        run: melos bootstrap

      - name: Start MinIO
        run: |
          docker run -d --name minio \
            -p 9000:9000 \
            -e MINIO_ROOT_USER=minioadmin \
            -e MINIO_ROOT_PASSWORD=minioadmin \
            minio/minio:latest server /data

          # Wait for MinIO to be ready
          for i in {1..30}; do
            if curl -sf http://localhost:9000/minio/health/live > /dev/null 2>&1; then
              echo "MinIO is ready"
              break
            fi
            sleep 1
          done

      - name: Setup MinIO bucket
        run: |
          docker run --rm --network host --entrypoint /bin/sh minio/mc:latest -c "
            mc alias set repub http://localhost:9000 minioadmin minioadmin &&
            mc mb repub/repub --ignore-existing
          "

      - name: Run migrations
        run: dart run -C packages/repub_cli repub_cli migrate

      - name: Start server
        run: |
          dart run -C packages/repub_server repub_server &
          echo $! > /tmp/server.pid

          # Wait for server to be ready
          for i in {1..30}; do
            if curl -sf http://localhost:8080/health > /dev/null 2>&1; then
              echo "Server is ready"
              break
            fi
            sleep 1
          done

          curl -sf http://localhost:8080/health || exit 1

      - name: Create auth token
        id: token
        run: |
          TOKEN=$(dart run -C packages/repub_cli repub_cli token create ci-test publish:all 2>&1 | grep "^Created token:" | cut -d: -f2 | tr -d ' ')
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          echo "Token created successfully"

      - name: Create test package
        run: |
          mkdir -p /tmp/test_pkg/lib

          cat > /tmp/test_pkg/pubspec.yaml << 'EOF'
          name: integration_test_pkg
          version: 1.0.0
          description: Integration test package for CI
          environment:
            sdk: ^3.0.0
          publish_to: http://localhost:8080
          EOF

          cat > /tmp/test_pkg/lib/integration_test_pkg.dart << 'EOF'
          /// Integration test package.
          library;

          /// Returns a test message.
          String testMessage() => 'Integration test successful!';
          EOF

          cat > /tmp/test_pkg/CHANGELOG.md << 'EOF'
          ## 1.0.0
          - Initial release
          EOF

          cat > /tmp/test_pkg/LICENSE << 'EOF'
          MIT License
          EOF

      - name: Publish test package
        run: |
          # Add token to dart pub
          echo "${{ steps.token.outputs.token }}" | dart pub token add http://localhost:8080

          cd /tmp/test_pkg
          dart pub publish --force

          echo "Package published successfully"

      - name: Verify package in registry
        run: |
          # Check package exists via API
          response=$(curl -sf http://localhost:8080/api/packages/integration_test_pkg)

          if echo "$response" | grep -q '"name":"integration_test_pkg"'; then
            echo "Package found in registry"
          else
            echo "Package not found!"
            echo "Response: $response"
            exit 1
          fi

          if echo "$response" | grep -q '"version":"1.0.0"'; then
            echo "Version 1.0.0 verified"
          else
            echo "Version not found!"
            exit 1
          fi

      - name: Download and use published package
        run: |
          mkdir -p /tmp/consumer_app/bin

          cat > /tmp/consumer_app/pubspec.yaml << 'EOF'
          name: consumer_app
          version: 1.0.0
          environment:
            sdk: ^3.0.0
          dependencies:
            integration_test_pkg:
              hosted:
                url: http://localhost:8080
              version: ^1.0.0
          EOF

          cat > /tmp/consumer_app/bin/main.dart << 'EOF'
          import 'package:integration_test_pkg/integration_test_pkg.dart';

          void main() {
            print(testMessage());
          }
          EOF

          cd /tmp/consumer_app
          dart pub get

          output=$(dart run bin/main.dart)

          if echo "$output" | grep -q "Integration test successful!"; then
            echo "Consumer app executed successfully!"
            echo "Output: $output"
          else
            echo "Unexpected output: $output"
            exit 1
          fi

      - name: Test package versions endpoint
        run: |
          response=$(curl -sf http://localhost:8080/api/packages/integration_test_pkg/versions/1.0.0)

          if echo "$response" | grep -q '"version":"1.0.0"'; then
            echo "Version endpoint working correctly"
          else
            echo "Version endpoint failed"
            echo "Response: $response"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          # Remove token
          dart pub token remove http://localhost:8080 || true

          # Stop server
          if [ -f /tmp/server.pid ]; then
            kill $(cat /tmp/server.pid) 2>/dev/null || true
          fi

          # Stop MinIO container
          docker stop minio 2>/dev/null || true
          docker rm minio 2>/dev/null || true
